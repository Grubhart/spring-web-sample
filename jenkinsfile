pipeline {
    agent any
    environment {
        PROJECT_ID = 'testci20200723'
        CLUSTER_NAME = 'deployment'
        LOCATION = 'us-central1-b'
        CREDENTIALS_ID = 'testCI20200723'
        SERVICE_ACCOUNT = 'jenkins-service-account'
    }
    stages {
        stage("Checkout code") {
                    steps {
                        checkout scm
                    }
                }
        stage("test code") {
                            steps {
                                sh("./gradlew clean test")
                            }
                        }
        stage("Build code") {
                    steps {
                        sh("./gradlew clean bootjar")
                    }
                }
        stage("Build image") {
                    steps {
                        script {
                             myapp = docker.build("gcr.io/testci20200723/websample:'${env.BUILD_ID}'")
                             sh("docker tag gcr.io/testci20200723/websample:'${env.BUILD_ID}' gcr.io/testci20200723/websample:latest")
                        }
                    }
                }
        stage("Push image") {
                    steps {
                        script {
                            withCredentials([file(credentialsId: 'jenkins-service-account', variable: 'GC_key')]) {
                                                sh("gcloud auth activate-service-account --key-file='${GC_key}'")
                                                sh('gcloud auth configure-docker')
                                                sh("docker push gcr.io/'${env.PROJECT_ID}'/websample:'${env.BUILD_ID}'")
                                                sh("docker push gcr.io/'${env.PROJECT_ID}'/websample:latest")
                            }
                        }
                    }
                }
    }
}
